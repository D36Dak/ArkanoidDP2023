@page "/game"
@using Arkanoid.Data.Tiles;
@using Arkanoid.Data.Tiles.Decorator;
@using Microsoft.AspNetCore.SignalR.Client
@using System.Timers
@using Arkanoid.Data
@using System.Numerics;
@using Arkanoid.Data.Strategy;
@inject NavigationManager Navigation
@implements IAsyncDisposable

<PageTitle>Game</PageTitle>

<h1>Game view</h1>
<button class="btn btn-primary" disabled="@(!canStart)" @onclick="GE.StartTimer">Start</button>
<button class="btn btn-primary" @onclick="GE.StopTimer">Stop</button>
<button class="btn btn-primary" @onclick="GE.ResetBallPosition">Reset</button>
<button class="btn btn-primary" @onclick="Subscribe">Join game</button>
<div>
    <button class="btn btn-secondary" @onclick="RegularBall">Regular Ball</button>
    <button class="btn btn-secondary" @onclick="FastBall">Fast Ball</button>
    <button class="btn btn-secondary" @onclick="TeleportingBall">Teleporting Ball</button>
</div>

@* <div style="top: @(top)px; left: @(left)px; position: relative">test</div> *@
<div id="level" @onkeypress="KeyPressEvent"
     style="background-color: #000000; width: @(GE.GetWindowWidth())px; height: @(GE.GetWindowHeight())px; margin: auto; position:relative"
     tabindex="0">
    <div style="color: white; top: @(GE.GetBallY())px; left: @(GE.GetBallX())px; width: 1px; position: relative"><img width="@GE.GetBallSize()" height="@GE.GetBallSize()" src="https://static.vecteezy.com/system/resources/previews/016/314/339/original/red-circle-red-dot-icon-free-png.png" /></div>
    <div style="width:@(P1.GetWidth())px;height:20px;border:1px solid red;background-color:@P1.color; top:@(GE.GetWindowHeight()-60)px; left:@(P1.GetX())px; position:absolute; display:inline-block"></div>
    <div style="width:@(P2.GetWidth())px;height:20px;border:1px solid red;background-color:@P2.color; top:@(GE.GetWindowHeight()-60)px; left:@(P2.GetX())px; position:absolute; display:inline-block"></div>
    @if (GE.tm is not null)
    {
        @foreach (var tile in GE.tm.tiles.ToList())
        {
            <div style="background: @(tile.Color); width: @(tile.Width)px; height: @(tile.Height)px; position: absolute; top: @(tile.Position.Y)px; left: @(tile.Position.X)px;"></div>
        }
    }
</div>
<button @onclick="TEST">TEST</button>
<br />

@code {
    private GameEngine? GE = null;//GameEngine.GetInstance(navigation);
    private HubConnection? hubConnection;
    private Paddle P1;
    private Paddle P2;
    private Paddle? myPlayer;
    bool canStart = true;

    public void TEST()
    {
        GE.tm.DestroyTile(GE.tm.tiles[0]);

    }

    protected override async Task OnInitializedAsync()
    {
        GE = GameEngine.GetInstance();
        P1 = GE.P1;
        P2 = GE.P2;
        TileFactory tf = new();

        Vector2 offset = new Vector2(40, 20);
        Vector2 gap = new Vector2(20, 20);
        int width = 100;
        int height = 50;
        hubConnection = new HubConnectionBuilder()
        .WithUrl(Navigation.ToAbsoluteUri("/gamehub"))
        .Build();
        if (GE.tm is null)
        {
            TileManager tm = new TileManager(hubConnection);
            for (var i = 0; i < 3; i++)
            {
                for (var j = 0; j < 10; j++)
                {
                    var pos = new Vector2(offset.X + j * (width + gap.X), offset.Y + i * (height + gap.Y));
                    Component tile = tf.CreateTile(TileType.Regular, pos);
                    tm.tiles.Add(tile);
                }
            }
            GE.tm = tm;
        }

        GE.ConnectToHub(hubConnection);
        hubConnection.On<int, int, string>("ReceivePosition", (x, y, tag) =>
        {
            if (tag == "ball")
            {
                //GE.SetBallPosition(x, y);
                InvokeAsync(StateHasChanged);
            }
        });

        hubConnection.On<int, Side>("ReceivePlayerPosition", (x, side) =>
        {
            Paddle p = P1;
            if (p.side != side)
            {
                p = P2;
            }

            p.SetX(x);
            InvokeAsync(StateHasChanged);
        });

        hubConnection.On<string, Side>("PlayerJoin", (id, side) =>
        {
            Console.WriteLine($"Joined {id} {side}");


            // change player color to indicate that joined. later...
            if (id.Equals(hubConnection.ConnectionId))
            {
                Paddle p;
                if (side == Side.RIGHT)
                {
                    p = P2;
                }
                else
                {
                    p = P1;
                }
                Console.WriteLine("Set player id to " + id);
                // my player should only be on singleton probably
                p.id = id;
                myPlayer = p;
                myPlayer.color = "olive";
                Console.WriteLine($"PaddleID {myPlayer.side}");
                InvokeAsync(StateHasChanged);
            }
        });

        hubConnection.On<string, Side>("PlayerLeft", (id, side) =>
        {
            Paddle p;
            if (side == Side.RIGHT)
            {
                p = P2;
            }
            else
            {
                p = P1;
            }
            // change color to indicate that player left

        });

        await hubConnection.StartAsync();
    }

    private async Task KeyPressEvent(KeyboardEventArgs args)
    {
        if (myPlayer == null) return;
        switch (args.Key)
        {
            case "a":
                myPlayer.MoveRight();
                await SendPaddlePosition(myPlayer);
                break;
            case "d":
                myPlayer.MoveLeft();
                await SendPaddlePosition(myPlayer);
                break;
            default:
                Console.WriteLine("Wrong key try a or d");
                break;

        }
    }

    private async Task SendPaddlePosition(Paddle p)
    {
        if (hubConnection is not null)
        {
            await hubConnection.SendAsync("SetPlayerPosition", p.GetX(), p.side);
        }
    }
    private async Task Subscribe()
    {
        if (hubConnection is not null)
        {
            string? id = hubConnection.ConnectionId;
            if (id != null)
                await hubConnection.SendAsync("Subscribe", id);
        }
    }

    public bool IsConnected =>
        hubConnection?.State == HubConnectionState.Connected;

    public async ValueTask DisposeAsync()
    {
        if (hubConnection is not null)
        {
            await hubConnection.DisposeAsync();
        }
    }
    private void RegularBall()
    {
        if (GE is not null)
        {
            GE.SetBallMovementStrategy(new RegularBallStrategy());
        }
    }
    private void FastBall()
    {
        if (GE is not null)
        {
            GE.SetBallMovementStrategy(new FastBallStrategy());
        }
    }
    private void TeleportingBall()
    {
        if (GE is not null)
        {
            GE.SetBallMovementStrategy(new TeleportSideStrategy());
        }
    }
    //----------------------------------------
}